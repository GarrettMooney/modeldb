<!DOCTYPE html>
  
  
  
  
   <html class="no-js"> 

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/solarized_dark.min.css">
  <head lang="en-us">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <title>KMeans Clustering - modeldb</title>
    <meta name="generator" content="Hugo 0.29" />

    
    <meta name="description" content="It uses dplyr programming to fit models inside the database.">
    
    <link rel="canonical" href="/articles/kmeans/">
    
    <meta name="author" content="Edgar Ruiz">
    

    <meta property="og:url" content="/articles/kmeans/">
    <meta property="og:title" content="modeldb">
    
    <meta name="apple-mobile-web-app-title" content="modeldb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="shortcut icon" type="image/x-icon" href="/logo.png">
    <link rel="icon" type="image/x-icon" href="/logo.png">

    <style>
      @font-face {
        font-family: 'Icon';
        src: url('/fonts/icon.eot');
        src: url('/fonts/icon.eot')
               format('embedded-opentype'),
             url('/fonts/icon.woff')
               format('woff'),
             url('/fonts/icon.ttf')
               format('truetype'),
             url('/fonts/icon.svg')
               format('svg');
        font-weight: normal;
        font-style: normal;
      }
    </style>

    <link rel="stylesheet" href="/stylesheets/application.css">
    <link rel="stylesheet" href="/stylesheets/temporary.css">
    <link rel="stylesheet" href="/stylesheets/palettes.css">
    <link rel="stylesheet" href="/stylesheets/highlight/highlight.css">

    
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ubuntu:400,700|Ubuntu&#43;Mono">
    <style>
      body, input {
        font-family: 'Ubuntu', Helvetica, Arial, sans-serif;
      }
      pre, code {
        font-family: 'Ubuntu Mono', 'Courier New', 'Courier', monospace;
      }
    </style>

    
    <script src="/javascripts/modernizr.js"></script>

    

  </head>
  <body class="palette-primary-blue palette-accent-light-green">



	
	


<div class="backdrop">
	<div class="backdrop-paper"></div>
</div>

<input class="toggle" type="checkbox" id="toggle-drawer">
<input class="toggle" type="checkbox" id="toggle-search">
<label class="toggle-button overlay" for="toggle-drawer"></label>

<header class="header">
	<nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        modeldb - KMeans Clustering
      </div>
    </div>

    
    <div class="button button-twitter" role="button" aria-label="Twitter">
       <a href="https://twitter.com/theotheredgar" title="@theotheredgar on Twitter" target="_blank" class="toggle-button icon icon-twitter"></a>
    </div>
    

    
    <div class="button button-github" role="button" aria-label="GitHub">
      <a href="https://github.com/edgararuiz" title="@edgararuiz on GitHub" target="_blank" class="toggle-button icon icon-github"></a>
    </div>
    
    
        
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
</header>

<main class="main">
	<div class="drawer">
		<nav aria-label="Navigation">
  <a href="https://github.com/edgararuiz/modeldb" class="project">
    <div class="banner">
      
      <div class="name">
        <strong>modeldb <span class="version">v.0.0.900</span></strong>

      </div>
    </div>
  </a>

  <div class="scrollable">
    <div class="wrapper">
      
        <ul>
          <li>
            <p>
              
              <a href="https://travis-ci.org/edgararuiz/modeldb">
                <img src="https://travis-ci.org/edgararuiz/modeldb.svg?branch=master" alt="Build Status" />
              </a>
              
            </p>

          </li>
        </ul>
        <hr>
      

      <div class="toc">
        
        <ul>
          




<li>
  
    



<a  title="Home" href="/">
	
	Home
</a>



  
</li>



<li>
  
    <span class="section">Articles</span>
    <ul>
      
        
        



<a class="current" title="KMeans Clustering" href="/articles/kmeans/">
	
	KMeans Clustering
</a>


<ul id="scrollspy">
</ul>


      
        
        



<a  title="Linear Regression" href="/articles/linear_regression/">
	
	Linear Regression
</a>



      
    </ul>
  
</li>


        </ul>
        

        
        <hr>
        <span class="section">The author</span>
        
        <ul>
          
          <li>
            <a href="https://twitter.com/theotheredgar" target="_blank" title="@theotheredgar on Twitter">
              @theotheredgar on Twitter
            </a>
          </li>
          

          
          <li>
            <a href="https://github.com/edgararuiz" target="_blank" title="@edgararuiz on GitHub">
              @edgararuiz on GitHub
            </a>
          </li>
          

          
        </ul>
        
      </div>
    </div>
  </div>
</nav>

	</div>

	<article class="article">
		<div class="wrapper">
			<h1>KMeans Clustering </h1>

			<div id="intro" class="section level2">
<h2>Intro</h2>
<p>The <code>simple_kmeans()</code> function enables running the KMeans model inside the database. It uses <code>dplyr</code> programming to abstract the steps needed produce a model, so that it can then be translated into SQL statements in the background.</p>
</div>
<div id="example-setup" class="section level2">
<h2>Example setup</h2>
<p>In this example, a simple <code>RSQlite</code> database will be use to load the <code>flights</code> data from the <code>nycflights13</code> library.</p>
<pre class="r"><code>library(dplyr)

con &lt;- DBI::dbConnect(RSQLite::SQLite(), path = &quot;:memory:&quot;)
RSQLite::initExtension(con)

db_flights &lt;- copy_to(con, nycflights13::flights, &quot;flights&quot;)</code></pre>
</div>
<div id="running-kmeans-clustering" class="section level2">
<h2>Running Kmeans clustering</h2>
<p>The function <code>simple_kmeans()</code> can use with local data, or a remote table, such as the <code>db_flights</code> variable that is a pointer to the “flights” table inside the SQLite database. When piping to the function, the only other required arguments are two or more fields separated by comma. Because it uses ‘tidyeval’, the variable name auto-completion will work.</p>
<pre class="r"><code>library(modeldb)

km &lt;- db_flights %&gt;%
  simple_kmeans(dep_time, distance)</code></pre>
<p>The <code>simple_kmeans()</code> function uses a progress bar to show you the current cycle, the maximum cycles it’s expected to run, the current difference between the previous cycle and the current cycle, and the running time. The loop will stop once it wither has two matching consecutive cycles, or if it reaches the maximum number of cycles, as determined by the <code>max_repeats</code> argument.</p>
<p>The final <strong>centers</strong> are are stored in the <code>centers</code> variable of the returned object</p>
<pre class="r"><code>km$centers</code></pre>
<pre><code>## # A tibble: 3 x 2
##   dep_time distance
##      &lt;dbl&gt;    &lt;dbl&gt;
## 1     890.     791.
## 2    1391.    2355.
## 3    1746.     718.</code></pre>
<p>The latest results are stored in the <code>tbl</code> variable of the returned object. The type of the returned table will match the type of the original source, so if it is a remote source, such as database table, then <code>tbl</code> will be a class <code>tbl_sql</code>. This will allow us to do two thing:</p>
<ul>
<li>View the actual results by running the query via R. This will allow us to perform further operations if needed:</li>
</ul>
<pre class="r"><code>head(km$tbl, 10)</code></pre>
<pre><code>## # Source:   lazy query [?? x 3]
## # Database: sqlite 3.22.0 []
##    dep_time distance center  
##       &lt;int&gt;    &lt;dbl&gt; &lt;chr&gt;   
##  1      517    1400. center_1
##  2      533    1416. center_1
##  3      542    1089. center_1
##  4      544    1576. center_1
##  5      554     762. center_1
##  6      554     719. center_1
##  7      555    1065. center_1
##  8      557     229. center_1
##  9      557     944. center_1
## 10      558     733. center_1
## # ... with more rows</code></pre>
<ul>
<li>View the SQL statement that was used to find the final centers:</li>
</ul>
<pre class="r"><code>dbplyr::remote_query(km$tbl)</code></pre>
<pre><code>## &lt;SQL&gt; SELECT `dep_time`, `distance`, `center`
## FROM (SELECT `dep_time`, `distance`, `center_1`, `center_2`, `center_3`, CASE
## WHEN (`center_1` &gt;= `center_1` AND `center_1` &lt; `center_2` AND `center_1` &lt; `center_3`) THEN (&#39;center_1&#39;)
## WHEN (`center_2` &lt; `center_1` AND `center_2` &gt;= `center_2` AND `center_2` &lt; `center_3`) THEN (&#39;center_2&#39;)
## WHEN (`center_3` &lt; `center_1` AND `center_3` &lt; `center_2` AND `center_3` &gt;= `center_3`) THEN (&#39;center_3&#39;)
## END AS `center`
## FROM (SELECT `dep_time`, `distance`, SQRT(((889.757881651311 - `dep_time`) * (889.757881651311 - `dep_time`)) + ((791.286862996562 - `distance`) * (791.286862996562 - `distance`))) AS `center_1`, SQRT(((1391.08534916316 - `dep_time`) * (1391.08534916316 - `dep_time`)) + ((2355.04462033144 - `distance`) * (2355.04462033144 - `distance`))) AS `center_2`, SQRT(((1745.74853136521 - `dep_time`) * (1745.74853136521 - `dep_time`)) + ((718.043515631104 - `distance`) * (718.043515631104 - `distance`))) AS `center_3`
## FROM (SELECT *
## FROM (SELECT `dep_time`, `distance`
## FROM `flights`)
## WHERE (NOT(((`dep_time`) IS NULL)) AND NOT(((`distance`) IS NULL))))))
## WHERE (NOT(((`center`) IS NULL)))</code></pre>
</div>
<div id="under-the-hood" class="section level2">
<h2>Under the hood</h2>
<p>The <code>simple_kmeans()</code> function uses <code>dplyr</code> and ‘tidyeval’ to run the KMeans algorithm. This means that when combined with <code>dbplyr</code>, the routines can be run inside a database.</p>
<p>Unlike other packages that use this same methodology, such as <code>dbplot</code> and <code>tidypredict</code>, <code>simple_kmeans()</code> does not create a single <code>dplyr</code> code that can be extracted as SQL. The function produces multiple, serial and dependent SQL statements that run individually inside the database. Each statement uses the current <em>centroids</em>, or centers, to estimate new centroids, and then it uses those centroids in a consecutive SQL statement to see if there was any variance. Effectively, this approach uses R not only as translation layer, but also as an orchestration layer.</p>
</div>
<div id="safeguards-for-long-running-jobs" class="section level2">
<h2>Safeguards for long running jobs</h2>
<p>The<code>simple_kmeans()</code> approach of using multiple and consecutive SQL queries to find the optimal centers, additionally, in KMeans clustering, it matters the order in which the each set of centers is passed. This creates an imperative to find a way to cache the current centers used in a long running job, in case the job is canceled or fails. Starting from the centers that were calculated last, will mean that re-starting the job will not being from “0”, but from a more advanced, read closer, set of centers.</p>
<p>The safeguard implemented in this function is trough a file, called <em>kmeans.csv</em>. Each cycle will update the file. The file name can be changed by modifying the <code>safeguard_file</code> argument. Setting the argument to NULL will turn off the safeguard. The file will be saved to the temporary directory of the R session..</p>
<p>In this example we will set the <code>max_repats</code> to 10, so as to artificially avoid finding the optimal means</p>
<pre class="r"><code>km &lt;- db_flights %&gt;%
  simple_kmeans(dep_time, distance, max_repeats = 10)</code></pre>
<p>In the next run, the “kmeans.csv” file is passed as the <code>initial_kmeans</code> argument. This will make <code>simple_kmeans()</code> use those centers as the starting point:</p>
<pre class="r"><code>km &lt;- db_flights %&gt;%
  simple_kmeans(dep_time, distance, initial_kmeans = read_csv(file.path(tempdir(), &quot;kmeans.csv&quot;)))</code></pre>
<pre><code>## Parsed with column specification:
## cols(
##   dep_time = col_double(),
##   distance = col_double()
## )</code></pre>
<p>The second run took 7 cycles to complete, which adds up to the 17 cycles that it initially took in the first example at the top of this article.</p>
</div>
<div id="visualizations" class="section level2">
<h2>Visualizations</h2>
<p>Because visualizing a large amount of data may be both compute intensive and visually challenging. The <code>modeldb</code> package offers a helper function to aid with this task.</p>
<p>The <code>plot_kmeans</code> function uses ‘ggplot2’ to display the results of a KMeans routine. Instead of a scatterplot, it uses a square grid that displays the concentration of intersections per square. The number of squares in the grid can be customized for more or less fine grain.</p>
<p>For large result-sets in remote sources, downloading every intersection will be a long running, costly operation. The approach of this function is to divide the x and y plane in a grid and have the remote source figure the total number of intersections, returned as a single number. This reduces the granularity of the visualization, but it speeds up the results.</p>
<p>The calculation operations will take place inside the database. It requires a database that supports functions like <strong>MIN</strong>, which SQLite does not support, so for this example, we will collect the data into R first (please do not use this step if working with a enterprise grade database)</p>
<pre class="r"><code>km$tbl &lt;- collect(km$tbl) # ONLY USE THIS STEP IF WORKING WITH SQLITE</code></pre>
<pre class="r"><code>library(ggplot2)

km$tbl %&gt;%
  plot_kmeans(dep_time, distance)</code></pre>
<p><img src="/articles/kmeans_files/figure-html/unnamed-chunk-9-1.png" width="960" /></p>
<p>Reduce the resolution for faster results and larger squares:</p>
<pre class="r"><code>km$tbl %&gt;%
  plot_kmeans(dep_time, distance, resolution = 30)</code></pre>
<p><img src="/articles/kmeans_files/figure-html/unnamed-chunk-10-1.png" width="960" /></p>
</div>


			<aside class="copyright" role="note">
				
				&copy; 2018 Released under the GPL-3 license &ndash;
				
				Documentation built with
				<a href="https://github.com/r-lib/pkgdown/">pkgdown</a>,
				<a href="https://github.com/rstudio/blogdown">blogdown</a>, and 
				<a href="https://www.gohugo.io" target="_blank"> Hugo</a> using the
				<a href="http://github.com/digitalcraftsman/hugo-material-docs" target="_blank">Material</a> theme.
				
			</aside>

			<footer class="footer">
				

<nav class="pagination" aria-label="Footer">
  <div class="previous">
  
  </div>

  <div class="next">
  
      <a href="/articles/linear_regression/" title="Linear Regression">
        <span class="direction">
          Next
        </span>
        <div class="page">
          <div class="stretch">
            <div class="title">
              Linear Regression
            </div>
          </div>
          <div class="button button-next" role="button" aria-label="Next">
            <i class="icon icon-forward"></i>
          </div>
        </div>
      </a>
  
  </div>
</nav>





			</footer>
		</div>
	</article>

	<div class="results" role="status" aria-live="polite">
		<div class="scrollable">
			<div class="wrapper">
				<div class="meta"></div>
				<div class="list"></div>
			</div>
		</div>
	</div>
</main>

    <script>
    
      var base_url = '\/';
      var repo_id  = 'edgararuiz\/modeldb';
    
    </script>

    <script src="/javascripts/application.js"></script>
    

    <script>
      /* Add headers to scrollspy */
      var headers   = document.getElementsByTagName("div");
      var scrollspy = document.getElementById('scrollspy');
      if(scrollspy) {
        if(headers.length > 0) {
          for(var i = 0; i < headers.length; i++) {
            if(headers[i].id.length > 0){
              var li = document.createElement("li");
              li.setAttribute("class", "anchor");
  
              var a  = document.createElement("a");
              a.setAttribute("href", "#" + headers[i].id);
              a.setAttribute("title", headers[i].innerHTML);
              a.innerHTML = headers[i].getElementsByTagName("h2")[0].innerHTML;
  
              li.appendChild(a)
              scrollspy.appendChild(li);
            }            
            
          }
        } else {
          scrollspy.parentElement.removeChild(scrollspy)
        }
      }
    </script>

    

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

